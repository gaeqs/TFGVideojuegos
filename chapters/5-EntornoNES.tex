\chapter{Entorno de desarrollo \textit{NES}}\label{ch:entorno-de-desarrollo-nes}

En este capítulo se abordará el desarrollo de \textit{NES4JAMS},
un componente que aporta a \textit{JAMS} un entorno de desarrollo
integrado para la creación de videojuegos de la consola
\textit{NES}.
Gracias a la arquitectura de \textit{JAMS}, este componente
aprovechará muchas de las características desarrolladas
para el entorno de desarrollo \textit{MIPS32} presente
por defecto en la aplicación.
Este entorno de desarrollo consistirá de un editor
de texto, un ensamblador y un simulador.


\section{Creación de un proyecto}\label{sec:creacion-de-un-proyecto}

\begin{figure}[h]
    \centering
    \includegraphics[width=0.8\textwidth]{images/nes/nes-project-creation}
    \caption{Creación de un proyecto \textit{NES}}
    \label{fig:nes-project-creation}
\end{figure}

\textit{NES4JAMS} añade un nuevo tipo de proyecto
que incorpora todas las herramientas para el desarrollo
de videojuegos de \textit{NES}.
Los usuarios podrán crear nuevos proyectos de este tipo
desde el menú de creación de proyectos.
Como los proyectos de \textit{NES} están destinados
a una consola muy específica, el usuario solo debe
especificar \textbf{el nombre y la localización del proyecto},
como se puede observar en la figura \ref{fig:nes-project-creation}.

Una vez creado el proyecto, \textit{JAMS} mostrará una ventana
principal muy similar a la de los proyectos \textit{MIPS32}.


\section{Editor}\label{sec:editor}

Los desarrolladores de videojuegos de \textit{NES} trabajan con
dos tipos de archivo principales: los archivos \textit{asm}
para el código y los archivos \textit{pcx} para los gráficos.
\textit{NES4JAMS} permite al usuario editar los dos tipos de archivo
de manera sencilla.

Cuando el usuario desea editar uno de estos archivos,
debe seleccionarlo en la herramienta \textbf{explorador}.
Esta herramienta muestra una representación en forma de árbol
de la estructura del proyecto.
El usuario puede expandir y contraer carpetas, así como crear,
borrar y mover archivos.
Si el usuario usa el doble clic sobre un archivo editable, este se abrirá
en el editor.
Dependiendo del tipo de archivo, el editor será diferente,
como se puede observar en la figura \ref{fig:nes-editor}.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.8\textwidth]{images/nes/nes-editor}
    \caption{Editor de código y de gráficos junto con el explorador}
    \label{fig:nes-editor}
\end{figure}

El menú contextual del explorador presenta varias acciones que
pueden ejecutarse sobre las carpetas y los archivos
del proyecto.
Una de las opciones más particulares es la opción de añadir o eliminar
archivos de código o de gráficos del ensamblador.
Al ser \textit{JAMS} un entorno de desarrollo basado en \textbf{proyectos},
se ha de proporcionar una manera de incluir o excluir archivos del
videojuego resultante.
Con este simple sistema, el usuario podrá elegir qué archivos se debe ensamblar.
Los archivos a ensamblar estarán marcados en \textbf{verde} en el explorador,
y aparecerán en orden en los nodos \textbf{Archivos a ensamblar} y
\textbf{\textit{Sprites} a ensamblar}.
Cabe destacar que, como se verá más adelante, los el orden de ensamblaje
importa, por lo que esta herramienta permite ordenarlos de una manera sencilla.

Una vez el usuario abra un archivo, su editor aparecerá en la herramienta
principal de la sección: \textbf{el visualizador de archivos}.
\textit{NES4JAMS} implementa dos editores nuevos a \textit{JAMS}:
el editor de código \textit{MOS 6502} y el editor de gráficos \textit{PCX}.

\subsection{Editor de código}\label{subsec:editor-de-codigo}

El editor de código usa el sistema de indexación desarrollado
en la capa base de \textit{JAMS}, por lo que este editor también
puede considerarse un \textbf{editor de texto inteligente}:
el editor convierte el texto puro en los componentes ensamblador
representados, pudiendo así aportar ayudas al usuario.
El editor también tiene conocimiento de las referencias y el alcance de
todas las etiquetas y macros, tanto en el propio archivo a editar
como en el resto de archivos a ensamblar.
El editor también incorpora un \textbf{autocompletador}.
Esta herramienta ayuda al usuario cuando escribe código
aportando sugerencias de autocompletación, como se puede
observar en la figura \ref{fig:nes-autocompletion}.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.8\textwidth]{images/nes/nes-autocompletion}
    \caption{Autocompletador ayudando al usuario}
    \label{fig:nes-autocompletion}
\end{figure}

\subsection{Editor de gráficos}\label{subsec:editor-de-graficos}

El formato \textit{PCX} es un formato de imagen desarrollado
en el año 1985 que cuenta con una codificación \textit{run-length}.
Actualmente, el formato ha caído en desuso, pero sus propiedades
lo hacen un \textbf{gran candidato} para almacenar gráficos
de la \textit{NES} antes de ser ensamblados.
Esto se debe a su capacidad de codificar los colores mediante
una \textit{paleta} de una manera sencilla.
Al almacenar los valores de los píxeles como índices y no
como colores, el formato \textit{PCX} se convierte en un
candidato ideal para gráficos dependientes de una paleta
externa, como es el caso de los gráficos de una \textit{NES}.

El editor de archivos \textit{PCX} permite modificar los
gráficos del videojuego de una manera rápida y sencilla.
Este editor está pensado exclusivamente para gráficos
de \textit{NES}, por lo que cada pixel solo puede tomar
cuatro valores diferentes.
El color final se buscará en la paleta seleccionada.
El usuario puede cambiar el color de cada valor de la
paleta utilizando el botón central del ratón sobre
la casilla a cambiar.
Por motivos de accesibilidad, el usuario también puede
cambiar el color empleando el botón principal del
ratón mientras mantiene pulsada la tecla $Ctrl$.

Cabe destacar que, aunque este editor permite editar
archivos \textit{PCX} de cualquier tamaño, la consola
leerá el archivo como si tuviera un ancho de 128 píxeles.
Esto es debido a que las tablas donde se guardan los gráficos
en la consola tienen un tamaño de 16x16 patrones
de 8x8 píxeles cada uno.
Si se ensambla un archivo \textit{PCX} con otro ancho,
lo más probable es que los gráficos se conviertan en
\textbf{ruido}.
Los archivo \textit{PCX} creados por \textit{NES4JAMS}
siempre tienen el tamaño de una tabla de patrones,
es decir, de 128x128 píxeles.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.8\textwidth]{images/nes/nes-graphics-change}
    \caption{\textit{Super Mario Bros.} con los gráficos modificados}
    \label{fig:nes-graphics-change}
\end{figure}

\subsection{Archivos iNES}\label{subsec:archivos-nes}

El formato \textit{iNES} es el formato de archivo más utilizado
para almacenar videojuegos para la consola \textit{NES}.
Este formato comienza con una cabecera con los datos que suelen
estar codificados en el propio cartucho, como puede ser el modo
espejo, el controlador de memoria o la región.
Esta cabecera también contiene el tamaño de la región del
programa (\textit{PGR}) y la región de gráficos (\textit{CHR})
que prosiguen a la cabecera.

\textit{NES4JAMS} es capaz de \textbf{cargar y generar} archivos
\textit{iNES} de manera nativa.
Al abrir un archivo \textit{iNES}, \textit{NES4JAMS} mostrará
el editor mostrado en la figura \ref{fig:nes-ines-editor}.

\begin{figure}[h]
    \centering
    \includegraphics[width=0.8\textwidth]{images/nes/nes-ines-editor}
    \caption{Archivo \textit{iNES} en el editor}
    \label{fig:nes-ines-editor}
\end{figure}

En este editor el usuario podrá ejecutar una simulación
para el videojuego seleccionado, permitiéndole \textbf{modificar}
los parámetros de la cabecera del videojuego a cargar.
El usuario también tiene la opción de \textbf{exportar las tablas
de patrones} del cartucho en un archivo \textit{PCX}.
Una previsualización de estas tablas se puede observar en la parte
derecha del editor.
Por último, el editor da la opción de \textbf{guardar una copia}
del videojuego con los parámetros modificados.

\subsection{Configuraciones}\label{subsec:configuraciones}

\begin{figure}[h]
    \centering
    \includegraphics[width=0.8\textwidth]{images/nes/nes-configurations}
    \caption{Menú de configuraciones}
    \label{fig:nes-configurations}
\end{figure}

Igual que en el entorno de desarrollo para \textit{MIPS32},
el entorno de desarrollo \textit{NES} permite ensamblar
el programa con diferentes \textbf{configuraciones}.
Estas configuraciones definen los \textbf{parámetros de la cabecera}
del archivo \textit{iNES} resultante y los \textbf{bancos de memoria}
presentes en el cartucho.

Los bancos de memoria están definidos por una \textbf{dirección de inicio}
y un \textbf{tamaño} en bytes.
De manera muy similar a las directivas \textit{.text}
y \textit{.data} de \textit{MIPS32}, el desarrollador podrá
alternar entre bancos de memoria usando la directiva \textit{.bank}.

\textit{NES4JAMS} también incorpora una opción que impide a un
banco de memoria ser escrito en el cartucho.
Esta funcionalidad es muy importante para algunos videojuegos
avanzados, ya que les permite utilizar un banco de memoria como
una representación de una \textbf{memoria RAM} adicional
dentro del cartucho.